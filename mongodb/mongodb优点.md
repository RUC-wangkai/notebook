MongoDB In Action
MongoDB实战 (豆瓣) https://book.douban.com/subje...

MongoDB 我是作为几乎的初学者来看这本书的，因为之前看了点基础知识就直接用在了项目里，边用边学，虽然快速，但是难免心里有郁结，因为没成体系。这里准备用这本书来系统的学习一下。
这本书内容相当丰富，从历史讲起，介绍了mongodb的基本概念，设计实例最后还讲了一些高级用法如复制与分片，性能调优等，既有开发者视角，也有DBA视角，读完收获颇丰。

亮点：

MongoDB相对于关系数据库的优点有：可存储无Schema数据，读写吞吐量高（键值存储简单），扩展方便（自动分片，主从复制，主节点若发生故障从节点自动转为主节点），数据模型直观（一般不需要join连表查询）；相对于其它NoSQL如redis的优点有支持即时查询（redis只支持主键查询）。这也是为啥MongoDB能在关系数据库已经如此成熟的今天还能打下自己一片天地的原因

MongoDB应用场景：WEB应用如日志和实时分析（原子更新和固定集合，提供稳定的计数器和日志自动过期的功能），敏捷开发（因为无模式），缓存（完整的对象表示和简单的键值存储通常能获得比MySQL更高的查询速度）

shell可以很容易的查看任意方法的实现，只要输入不带括号的方法就行（这是js的特性）比如db.user.save就可以看出save其实就是对insert和update一个简单的封装，根据主键是否存在进行操作选择。

所有的MongoDB驱动都主要有三个功能：检查对象ID若无则生成（id可保证唯一，由4字节时间戳，3字节机器ID，2字节进程ID，3字节进程局部计数器组成，所以MongoDB一般不需要一个单独的字段来记录存储时间了），把语言特定的文档描述转换为BSON，使用MongoDB的网络协议通过TCP套接字与数据库通讯（安全模式决定了通讯是否可靠）

选择嵌套还是引用（正规化与否）的关键是判断读写比，选择嵌套优点是查询只需要一次就可以查完，简单快速，但是如果要修改就需要在每个出现嵌套信息的地方进行修改，但是如果确定修改的频率较低，或者嵌套对象不出现在父对象以外的其他上下文，那么嵌套就足以成为合理的设计。此外，如果信息量很大那么不适合用嵌套，应该用引用，可以避免或者推迟分片的到来。比如博客应用中文章的评论就非常适合嵌套

更新有两种方式，一种是通用性更新：从数据库获得完整对象，然后修改这个对象，然后保存，另一种是针对性更新:直接按条件修改数据库中一些对象的某些字段。前者的好处在于通用，可以将前台传来的表单无论修改了那个字段都可以直接保存，无需更多拼凑，修改任何字段的方法都是相同的，便于统一处理，后者的好处在于性能更好，因为节省了许多不必要字段的传递，而且允许原子性更新，比如inc

稀疏索引用于：不是所有文档都要用unique索引，这样可以避免某一类型数据（比如缺了一个字段）无法多次插入；集合中大量文档都不包含被索引的键，用稀疏索引可以节约内存

复制可以提供：冗余能够达到容灾或者挽救误删数据的效果；故障迁移可以在紧急情况下切换节点；简化维护工作，比如可以在主节点以外进行大开销操作如备份或者大数据的索引构建；均衡负载，读写分离

分片可以解决某一类型数据过大，不能单机存储的问题，同时能保持高性能读写。MongoDB自动分片策略应该可以替换大多我们自己手动分片的做法

书中还提出了许多最佳实践，比如常见的设计范式一对多、多对多、树形结构，这些都对我们在设计应用时有较大的参考价值

看这本书有点不爽的一点就是用ruby写的，这一门语言我没怎么接触过，但是却因为老板让我部署redmine而留下了痛苦回忆，真的是我用过的框架里面部署最麻烦的，所以一直也没有兴趣去了解这门语言，但是还好大部分语言的语法都是相似的，并不是很影响我看这本书。
另外还有一点就是 MongoDB 版本3和2差别较大，最明显的就是验证方式，需要及时更新。